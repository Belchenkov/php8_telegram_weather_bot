<?php

// https://api.telegram.org/bot6701436362:AAH4eAuc5bNty2zn9DAtbvf5JqQQVBhGFVw/setWebhook?url=https://php-bot-weather.sharedwithexpose.com
error_reporting(-1);

ini_set('display_errors', 0);
ini_set('log_errors', 0);
ini_set('error_log', __DIR__ . '/errors.log');

require_once __DIR__ . '/vendor/autoload.php';
require_once __DIR__ . '/config.php';
require_once __DIR__ . '/functions.php';

$telegram = new \Telegram\Bot\Api(TOKEN);
$update = $telegram->getWebhookUpdate();

$chat_id = $update['message']['chat']['id'] ?? 0;
$text = $update['message']['text'] ?? '';
$name = $update['message']['from']['first_name'] ?? 'Guest';

if (!$chat_id) {
    die;
}

match ($text) {
    '/start' => $telegram->sendMessage([
        'chat_id' => $chat_id,
        'text' => "–ü—Ä–∏–≤–µ—Ç, {$name}! üôã" . PHP_EOL . "–Ø –±–æ—Ç-—Å–∏–Ω–æ–ø—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Å–∫–∞–∂–µ—Ç –≤–∞–º –ø–æ–≥–æ–¥—É –≤ –ª—é–±–æ–º –≥–æ—Ä–æ–¥–µ –º–∏—Ä–∞. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é (–¥–æ—Å—Ç—É–ø–Ω–æ —Å –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤). \n–¢–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –≥–æ—Ä–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: <b>–ì–æ—Ä–æ–¥</b> –∏–ª–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>–ì–æ—Ä–æ–¥,–∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã</b>. \n–ü—Ä–∏–º–µ—Ä—ã: <b>London</b>, <b>London,uk</b>, <b>Kiev,ua</b>, <b>–ö–∏–µ–≤</b>",
        'parse_mode' => 'HTML',
    ]),
    '/help' => $telegram->sendMessage([
        'chat_id' => $chat_id,
        'text' => "–Ø –±–æ—Ç-—Å–∏–Ω–æ–ø—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Å–∫–∞–∂–µ—Ç –≤–∞–º –ø–æ–≥–æ–¥—É –≤ –ª—é–±–æ–º –≥–æ—Ä–æ–¥–µ –º–∏—Ä–∞. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é (–¥–æ—Å—Ç—É–ø–Ω–æ —Å –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤). \n–¢–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –≥–æ—Ä–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: <b>–ì–æ—Ä–æ–¥</b> –∏–ª–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>–ì–æ—Ä–æ–¥,–∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã</b>. \n–ü—Ä–∏–º–µ—Ä—ã: <b>London</b>, <b>London,uk</b>, <b>Kiev,ua</b>, <b>–ö–∏–µ–≤</b>",
        'parse_mode' => 'HTML',
    ]),
    default => false
};

if (!empty($text)) {
    $telegram->sendMessage([
        'chat_id' => $chat_id,
        'text' => "–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ...",
    ]);

    $weather_url .= "&q={$text}";
    $weather = send_request($weather_url);

    debug($weather);
} elseif (isset($update['message']['location'])) {
    $telegram->sendMessage([
        'chat_id' => $chat_id,
        'text' => "–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ...",
    ]);

    $weather_url .= "&lat={$update['message']['location']['latitude']}&lon={$update['message']['location']['longitude']}";
    $weather = send_request($weather_url);

    debug($weather);
} else {
    $telegram->sendMessage([
        'chat_id' => $chat_id,
        'text' => "–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ª–æ–∫–∞—Ü–∏–∏",
    ]);
}


